
## 자바스크립트 런타임 환경에 대한 이해.
#브라우져는 어떻게 동작하는가?


**java Script runTime(실행환경)
	-자바스크립트는 자바스크립트 엔진외에 다양한 실행환경 속에서 실행된다.
	-따라서 이런 실행환경에 대한 이해가 있어야 정확한 실행흐름을 생각하고 효과적인 소스를 작성할 수 있다.
	-js engine(callStack, Memory Heap)
	-Background
	-Task Queues( Task Queue, Micro Task Queue)
	-Event Loop


**JS 엔진의 영역
	-호출 스택
	-태스크 큐
	-힙 메모리.


**비동기API
	-웹 api영역에 따로 정의되어 있는 함수들은 비동기로 실행된다.
	-Web api 
		-DOM Events
		-Timer
		-AJAX	(XMLHttpRequest)



## 비동기API의 실행흐름.


1.백그라운드
	-특징
		수 많은 작업을 하는 별개의 일종의 멀티 스레드
		엔진이 코드를 수행하는 동안 API호출을 통해 전달받은 작업을 멀티스레드에서 동시다발적 수행
		콜스택에서 받은 명령을 콜스택이 진행되는 동안에 묵묵히 수행한다(이를 통해 동시성 연출가능)
	-백그라운드작업이 끝나면 전달받은 콜백을 이벤트 루프에 전달한다.
	-각 백그라운드 작업을 마치면, api(ex.setTimeout)가 호출될 때 전달받은 콜백함수를 타스크 큐에 삽입하기 위해 이벤트 루프에 전달한다.
	-setTiemout(fn,1000)인 경우 10초를 계산하는곳이 이 백그라운드다.
	-백그라운드에서는 연산이 끝나면 이벤트 큐로 연산결과를 보낸다.
	-비동기 db조회를 예를 들자면, 디비통신이 끝난시점에 태스크큐에 콜백함수와 DB조회결과가 이동한다고 보면된다.
	-ajax요청,이벤트 리스너, 파일리더 등이 있다.
	-백그라운드는 비동기 api가 작업을 완료하면 콜백 함수를 태스크 큐에 추가한다.

	-역할
	1)타임작업(setTimeout)
		:타임동작이 끝나면 함께 받은 콜백을 전달한다.
	2)이벤트리스너
		:이벤트를 감지하면 전달받은 콜백을 전달한다.
	3)프로미스
		: 프로미스 안에 담긴 작업을 수행 완ㄹ하면 then()으로 전달받은 콜백을 전달한다.

2.이벤트 루프(Event Loop)
	-특징
		단일 스레드
		HTML 스팩

	-수행역할
		a)완료된 백그라운드 작업(비동기API의 작업)이 끝나면 콜백을 전달받아 타스크큐에 넣는다.
		b)현재 실행중인 타스크가 없으면 (호출스택이 비면)  테스크큐에서 타스크하나 가져와 호출스택에 추가한다.

	-설명
		이벤트 루프는 자바스크립트 런타임의 중심에서 콜스택과 백그라운드 간의 업무처리를 돕는 중개자 역할을 한다.
		싱글스레드 환경의 자바스크립트 엔진과 상호연동하기 위한 장치.
		현재 실행중인 태스크가 없을때 (주로 호출 스택이 비워졌을 때) 태스크 큐의 첫 번째 태스크를 꺼내와 실행한다.



3.타스크 큐(Callback Que, event Que,task Que)

	-설명
		콜백 함수들이 대기하고 있는 큐메모리 형태의 배열.FIFO(First In First Out)
		대기중인 콜백함수들은 '현재 실행중인 타스크'가 없을 시에 이벤트 루프에 의해 콜 스택에 전달된다.
		이곳에 누적되는 콜백함수들은 백그라운드에서 작업이 끝났을때 이벤트 루프에 의해 적재된다.
		


**마이크로 태스크 큐(Micro Task Queue)
	-프로미스의 then() 메소드는 콜백메서드를 마이크로 태스크 큐에 추가한다.
	-이벤트 루프는 타스크 큐전에 마이크로 태스크 큐가 비었는지 확인한다. 즉 타스크 큐보다 실행 우선순위가 높다.
	-HTML 스펙의 perform a microtask checkpoint 참조.
	-프로미스는 자바스크립트의 스펙이지만 마이크로 태스크큐는 html의 스펙이다. 이 연관관계가 불명확하다.


**메세지 폴링

**setTimeout()의 두번째 파라미터는 '최소'지연시간을 보장한다.
	-이 말은 호출스택에 현재실행중인 함수가 있을 경우에 대기해야함을 의미한다.
	
**setTimeout(fn,0)의 의미에 대해서.
	-브라우저 환경에서는 자바스크립트 엔진뿐만 아니라 다른 여러가지 프로세스가 함께 구동된다
	-따라서 실행흐름이 JS엔진외에 웹api등의 다른 프로세스가 개입했을때 실행흐름을 착각할 수 있다.
	-예를들면 랜더링엔진같은 경우가 JS와 별도로 동작하는 경우이다.
	-렌더링 엔진의 태스크는 자바스크립트 엔진과 동일한 단일 태스크 큐를 통해 관리된다.
	-따라서 렌더링요청을 보내면 태스크 큐로 이동하게 되고 태스크큐는 호출스택이 비워지기를 기다린다.
	-이로 인해 렌더링시점이 달라질 수 있다.
	-이때 setTimeout(fn,0)을 이용해서 호출스택에 쌓여있을 스택들을 태스크큐로 보내면 원하는 방향으로 실행흐름을 만들 수 있다.


-잡 큐(job que)

**자바스크립트의 잡 큐를 어떻게 이벤트 루프와 연동할까

**최적화를 위한 프로그래밍
	-v8엔진의 구동원리에 대한 이해.
	-히든 클래스
	-동적프로그래밍은 추가비용이 발생한다. 미리 알 수 있는 정보들은 미리 정의하는게 가장 좋다.

1.객체 속성정의는 가능한 객체 생성시점에서 한다.
	-동적속성을 추가할시에 추가되는 속성의 순서를 맞춰주는게 더 빠르다.
2.여러가지 함수를 호출하는것보다 한가지 이미 호출되었던 함수를 반복 호출하는것이 낫다.
	->함수를 SOLID 원칙에 따라 정의해서 재활용성을 높혀라.

	->동적 속성추가는 비용이 많이 든다.


**용어정리


**메모리 힙 :
	-동적으로 만들어진 변수와 객체에 대한 메모리에 할당되는 곳
	-두조화 되지 않은 더미같은 메모리 영역
	

**호출 스택(Call Stack)
	-코드가 실행될 때 호출 스택에 순차적으로 쌓인다. LIFO(Last In First Out) 구조
	-Run to Completion : 하나의 함수가 실행되면 함수 실행이 끝날 때까지 다른 타스크가 실행될 수 없다.

**스택프레임
	-콜 스택에 쌓이는 하나의 스택을 말한다.

**스택 트레이스
	-예외가 발생했을 때 콜스택의 상태.
	-즉 에러발생 시점의 콜 스택의 구조를 확인함으로써 함수 호출과정을 통해 디버깅할 수 있다.

**스택 날림(Blowing the stack)
	-스택 오버플로우가 발생했을때 스택을 날리는 현상을 말한다.

**세션스택
	-웹앱의 실행과정을 순차적으로 기록하고 확인가능한 서비스, 유로다.

**스택 오버플로우
	-Uncaught RangeError: Maximum call stack size exceeded
	-호출 스택에 스택이 너무 많이 쌓여서 허용범위를 넘어서 범람했을때 나는 오류

**비동기 콜백
	-단일 스택, 싱글 스레드 환경에서 동시성(Concurrency)을 연출하기위한 방법중 하나.
	-만일 콜 스택에 수행시간이 긴 함수가 있을때 싱글 스레드 환경에서 끊김없는 환경을 연출하려면 어떻게 해야할까




**참고
http://jaynewho.com/post/25
https://meetup.toast.com/posts/89
https://developer.mozilla.org/ko/docs/Web/JavaScript/EventLoop
https://asfirstalways.tistory.com/362
https://d2.naver.com/helloworld/59361